# map the $forwarded_proto from $http_x_forwarded_proto or fallback to $scheme
map $http_x_forwarded_proto $forwarded_proto {
	default $scheme;
	'' $scheme;
	~.+ $http_x_forwarded_proto;
}

# detect suspicious characters to prevent off-by-slash/dir-traversal
map $request_uri $bad_path {
	default 0;
	~\\.\\. 1;
	~/\./ 1;
	~// 1;
}

map $request_uri $raw_path {
    default $request_uri;
    ~^([^?]*) $1;
}

map $raw_path $bad_encoded {
    default 0;
    ~*%2e%2e 1;  # ..
    ~*%2f    1;  # / => remove this if backward compatibility is needed
    ~*%5c    1;  # \
    ~*(%25(?:2e|2f|5c)) 1;  # double-encoded
}

map $request_uri $bad_ctl {
    default 0;
    ~*[\x00-\x1F\x7F] 1; # literal control characters
    ~*(%0d|%0a|%09|%1[0-9a-f]|%7f) 1; # encoded control characters
}
